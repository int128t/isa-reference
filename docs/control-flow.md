# Инструкции управления потоком x86-64

Инструкции управления потоком изменяют порядок выполнения программы. Они включают в себя условные и безусловные переходы, вызовы подпрограмм, возвраты, циклы и прерывания.

## Безусловные переходы

### JMP - Безусловный переход

#### Синтаксис
```
JMP target
```

#### Описание
Безусловно передает управление по указанному адресу.

#### Варианты
- `JMP rel8/16/32` - Относительный переход (короткий/ближний/дальний)
- `JMP r/m` - Косвенный переход через регистр или память
- `JMP ptr16:16/32/64` - Дальний переход с указанием сегмента (устаревший в 64-битном режиме)

#### Примеры
```assembly
JMP label           ; Переход на метку
JMP RAX             ; Переход по адресу в RAX
JMP [RBX]           ; Переход по адресу, хранящемуся в памяти по адресу в RBX
JMP 0x1000          ; Переход по абсолютному адресу
```

#### Флаги
Не влияет на флаги.

#### Применение
- Безусловные переходы в программе
- Реализация оператора goto
- Выход из циклов и условных блоков
- Реализация таблиц переходов (switch/case)

## Условные переходы

### Jcc - Условные переходы

#### Синтаксис
```
Jcc target
```
где cc - условие (например, E, NE, G, L и т.д.)

#### Описание
Выполняет переход, если указанное условие истинно. Условие проверяется на основе флагов.

#### Основные инструкции условных переходов

| Инструкция | Условие | Флаги | Описание |
|------------|---------|-------|----------|
| JE/JZ | Equal/Zero | ZF=1 | Равно/Ноль |
| JNE/JNZ | Not Equal/Not Zero | ZF=0 | Не равно/Не ноль |
| JG/JNLE | Greater/Not Less or Equal | ZF=0 и SF=OF | Больше (знаковое) |
| JGE/JNL | Greater or Equal/Not Less | SF=OF | Больше или равно (знаковое) |
| JL/JNGE | Less/Not Greater or Equal | SF≠OF | Меньше (знаковое) |
| JLE/JNG | Less or Equal/Not Greater | ZF=1 или SF≠OF | Меньше или равно (знаковое) |
| JA/JNBE | Above/Not Below or Equal | CF=0 и ZF=0 | Больше (беззнаковое) |
| JAE/JNB/JNC | Above or Equal/Not Below/Not Carry | CF=0 | Больше или равно (беззнаковое) |
| JB/JNAE/JC | Below/Not Above or Equal/Carry | CF=1 | Меньше (беззнаковое) |
| JBE/JNA | Below or Equal/Not Above | CF=1 или ZF=1 | Меньше или равно (беззнаковое) |
| JS | Sign | SF=1 | Отрицательный |
| JNS | Not Sign | SF=0 | Неотрицательный |
| JO | Overflow | OF=1 | Переполнение |
| JNO | Not Overflow | OF=0 | Нет переполнения |
| JP/JPE | Parity/Parity Even | PF=1 | Четный паритет |
| JNP/JPO | Not Parity/Parity Odd | PF=0 | Нечетный паритет |
| JCXZ/JECXZ/JRCXZ | CX/ECX/RCX Zero | CX/ECX/RCX=0 | Регистр равен нулю |

#### Примеры
```assembly
JE label            ; Переход на метку, если ZF=1 (равно)
JNE exit            ; Переход на метку exit, если ZF=0 (не равно)
JG loop_start       ; Переход на метку loop_start, если больше (знаковое)
JB error_handler    ; Переход на метку error_handler, если меньше (беззнаковое)
```

#### Флаги
Не влияет на флаги.

#### Применение
- Реализация условных операторов (if-else)
- Реализация циклов
- Обработка ошибок
- Сравнение значений

## Вызовы подпрограмм и возвраты

### CALL - Вызов подпрограммы

#### Синтаксис
```
CALL target
```

#### Описание
Сохраняет адрес следующей инструкции в стеке и передает управление по указанному адресу.

#### Варианты
- `CALL rel16/32` - Относительный вызов
- `CALL r/m` - Косвенный вызов через регистр или память
- `CALL ptr16:16/32/64` - Дальний вызов с указанием сегмента (устаревший в 64-битном режиме)

#### Примеры
```assembly
CALL function       ; Вызов функции по метке
CALL RAX            ; Вызов функции по адресу в RAX
CALL [RBX]          ; Вызов функции по адресу, хранящемуся в памяти по адресу в RBX
```

#### Флаги
Не влияет на флаги.

#### Применение
- Вызов функций и процедур
- Реализация подпрограмм
- Вызов методов объектов (через таблицы виртуальных функций)

### RET - Возврат из подпрограммы

#### Синтаксис
```
RET
RET imm16
```

#### Описание
Извлекает адрес возврата из стека и передает управление по этому адресу. Опциональный непосредственный операнд указывает, сколько байт нужно освободить из стека после возврата (используется для очистки аргументов, переданных через стек).

#### Примеры
```assembly
RET                 ; Возврат из подпрограммы
RET 16              ; Возврат из подпрограммы и освобождение 16 байт из стека
```

#### Флаги
Не влияет на флаги.

#### Применение
- Возврат из функций и процедур
- Завершение подпрограмм
- Реализация соглашений о вызовах

## Инструкции для циклов

### LOOP/LOOPE/LOOPNE - Организация циклов

#### Синтаксис
```
LOOP target
LOOPE/LOOPZ target
LOOPNE/LOOPNZ target
```

#### Описание
- `LOOP` - Уменьшает RCX на 1 и выполняет переход, если RCX не равен 0
- `LOOPE/LOOPZ` - Уменьшает RCX на 1 и выполняет переход, если RCX не равен 0 и ZF=1
- `LOOPNE/LOOPNZ` - Уменьшает RCX на 1 и выполняет переход, если RCX не равен 0 и ZF=0

#### Примеры
```assembly
    MOV RCX, 10     ; Инициализация счетчика
loop_start:
    ; Тело цикла
    LOOP loop_start ; Уменьшает RCX и переходит на loop_start, если RCX не равен 0
```

#### Флаги
Не влияет на флаги.

#### Применение
- Организация циклов с фиксированным числом итераций
- Обработка массивов и строк
- Реализация циклов for

## Инструкции прерываний и системных вызовов

### INT - Программное прерывание

#### Синтаксис
```
INT imm8
```

#### Описание
Вызывает обработчик прерывания с указанным номером. Сохраняет флаги и адрес возврата, затем передает управление обработчику.

#### Примеры
```assembly
INT 3               ; Прерывание для отладки
INT 0x80            ; Системный вызов в Linux (устаревший метод)
```

#### Флаги
Сохраняет флаги в стеке, затем устанавливает IF=0, TF=0.

#### Применение
- Системные вызовы (в устаревших системах)
- Отладка (INT 3)
- Вызов функций BIOS (в режиме реальных адресов)

### SYSCALL - Системный вызов (64-битный режим)

#### Синтаксис
```
SYSCALL
```

#### Описание
Быстрый системный вызов в 64-битном режиме. Сохраняет RIP в RCX, RFLAGS в R11, затем загружает RIP из IA32_LSTAR MSR.

#### Примеры
```assembly
MOV RAX, 1          ; Номер системного вызова (sys_write в Linux)
MOV RDI, 1          ; Первый аргумент (файловый дескриптор stdout)
MOV RSI, msg        ; Второй аргумент (адрес сообщения)
MOV RDX, len        ; Третий аргумент (длина сообщения)
SYSCALL             ; Вызов системной функции
```

#### Флаги
Сохраняет RFLAGS в R11, затем маскирует некоторые флаги.

#### Применение
- Системные вызовы в 64-битных операционных системах
- Взаимодействие с ядром ОС
- Низкоуровневый ввод-вывод

### SYSRET - Возврат из системного вызова (64-битный режим)

#### Синтаксис
```
SYSRET
```

#### Описание
Быстрый возврат из системного вызова в 64-битном режиме. Загружает RIP из RCX, RFLAGS из R11.

#### Флаги
Восстанавливает RFLAGS из R11.

#### Применение
- Возврат из обработчиков системных вызовов в пользовательский режим

## Другие инструкции управления потоком

### IRET/IRETD/IRETQ - Возврат из прерывания

#### Синтаксис
```
IRET
IRETD
IRETQ
```

#### Описание
Возврат из обработчика прерывания. Восстанавливает RIP, CS, RFLAGS (и другие регистры в зависимости от режима).

#### Флаги
Восстанавливает все флаги из стека.

#### Применение
- Возврат из обработчиков прерываний
- Возврат из обработчиков исключений

### ENTER/LEAVE - Создание/удаление стекового фрейма

#### Синтаксис
```
ENTER imm16, imm8
LEAVE
```

#### Описание
- `ENTER` - Создает стековый фрейм для процедуры. Сохраняет RBP, устанавливает RBP=RSP, затем выделяет пространство на стеке.
- `LEAVE` - Удаляет стековый фрейм. Устанавливает RSP=RBP, затем восстанавливает RBP.

#### Примеры
```assembly
ENTER 16, 0         ; Создает стековый фрейм с 16 байтами локальных переменных
; Тело функции
LEAVE               ; Удаляет стековый фрейм
RET                 ; Возврат из функции
```

#### Флаги
Не влияют на флаги.

#### Применение
- Создание и удаление стековых фреймов функций
- Доступ к локальным переменным и параметрам

## Инструкции предсказания переходов

### Префиксы подсказок для переходов

#### Синтаксис
```
JMP target          ; Без подсказки
JMP SHORT target    ; Короткий переход (8-битное смещение)
JMP NEAR target     ; Ближний переход (32-битное смещение)
```

#### Описание
Подсказки компилятору или ассемблеру о предполагаемой дальности перехода.

#### Применение
- Оптимизация размера кода
- Указание предпочтительного кодирования инструкций

## Примечания

1. Оптимизация условных переходов:
   - Процессоры x86-64 используют предсказание переходов для оптимизации выполнения
   - Предсказуемые переходы (например, в циклах) выполняются эффективнее
   - Непредсказуемые переходы могут вызывать значительные задержки из-за сброса конвейера

2. Дальность переходов:
   - Короткие переходы (SHORT): -128 до +127 байт от следующей инструкции
   - Ближние переходы (NEAR): -2^31 до +2^31-1 байт от следующей инструкции
   - В 64-битном режиме прямые переходы ограничены 2 ГБ (±2^31 байт)

3. Косвенные переходы:
   - Более медленные, чем прямые, из-за сложности предсказания
   - Используются для реализации виртуальных функций, switch/case и функциональных указателей
   - Могут быть уязвимы для атак типа Spectre

4. Соглашения о вызовах:
   - В x86-64 аргументы обычно передаются через регистры (первые 6 в Linux, первые 4 в Windows)
   - Стек должен быть выровнен по 16 байт перед вызовом функции
   - Возвращаемое значение обычно помещается в RAX

5. Системные вызовы:
   - В Linux: номер системного вызова в RAX, аргументы в RDI, RSI, RDX, R10, R8, R9
   - В Windows: номер системного вызова в RAX, аргументы в RCX, RDX, R8, R9