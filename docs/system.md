# Системные инструкции x86-64

Системные инструкции используются для управления процессором, взаимодействия с операционной системой и выполнения привилегированных операций. Большинство этих инструкций доступны только в режиме ядра (ring 0) и используются операционной системой.

## Инструкции управления системой

### CPUID - Идентификация процессора

#### Синтаксис
```
CPUID
```

#### Описание
Возвращает информацию о процессоре в зависимости от значения в регистре EAX (и иногда ECX).

#### Примеры
```assembly
MOV EAX, 0          ; Запрос информации о производителе
CPUID               ; Выполнение инструкции
; Результат: EBX:EDX:ECX содержит строку производителя

MOV EAX, 1          ; Запрос информации о семействе, модели и степпинге
CPUID               ; Выполнение инструкции
; Результат: EAX содержит информацию о версии, ECX и EDX - флаги возможностей
```

#### Флаги
Не влияет на флаги.

#### Применение
- Определение возможностей процессора
- Идентификация производителя и модели
- Проверка поддержки расширений (SSE, AVX и т.д.)
- Получение информации о кэше

### RDTSC - Чтение счетчика временных меток

#### Синтаксис
```
RDTSC
```

#### Описание
Считывает 64-битный счетчик временных меток процессора (Time Stamp Counter) и помещает младшие 32 бита в EAX, старшие 32 бита в EDX.

#### Примеры
```assembly
RDTSC               ; Чтение счетчика временных меток
; Результат: EDX:EAX содержит 64-битное значение счетчика
```

#### Флаги
Не влияет на флаги.

#### Применение
- Измерение времени выполнения кода
- Профилирование производительности
- Генерация случайных чисел

### RDTSCP - Чтение счетчика временных меток и идентификатора процессора

#### Синтаксис
```
RDTSCP
```

#### Описание
Аналогично RDTSC, но также возвращает идентификатор процессора в ECX и гарантирует, что все предыдущие инструкции завершены.

#### Примеры
```assembly
RDTSCP              ; Чтение счетчика временных меток и идентификатора процессора
; Результат: EDX:EAX содержит 64-битное значение счетчика, ECX содержит идентификатор процессора
```

#### Флаги
Не влияет на флаги.

#### Применение
- Более точное измерение времени выполнения кода
- Профилирование на многопроцессорных системах

### RDMSR - Чтение модельно-зависимого регистра

#### Синтаксис
```
RDMSR
```

#### Описание
Считывает 64-битный модельно-зависимый регистр (Model-Specific Register), указанный в ECX, и помещает младшие 32 бита в EAX, старшие 32 бита в EDX.

#### Примеры
```assembly
MOV ECX, 0x10       ; Указание MSR для чтения (например, IA32_TIME_STAMP_COUNTER)
RDMSR               ; Чтение MSR
; Результат: EDX:EAX содержит 64-битное значение MSR
```

#### Флаги
Не влияет на флаги.

#### Привилегии
Требует уровень привилегий 0 (режим ядра).

#### Применение
- Доступ к специальным регистрам процессора
- Настройка параметров процессора
- Диагностика и отладка

### WRMSR - Запись в модельно-зависимый регистр

#### Синтаксис
```
WRMSR
```

#### Описание
Записывает 64-битное значение из EDX:EAX в модельно-зависимый регистр (Model-Specific Register), указанный в ECX.

#### Примеры
```assembly
MOV ECX, 0x10       ; Указание MSR для записи
MOV EAX, 0          ; Младшие 32 бита значения
MOV EDX, 0          ; Старшие 32 бита значения
WRMSR               ; Запись в MSR
```

#### Флаги
Не влияет на флаги.

#### Привилегии
Требует уровень привилегий 0 (режим ядра).

#### Применение
- Настройка параметров процессора
- Управление энергопотреблением
- Настройка производительности

## Инструкции ввода-вывода

### IN - Ввод из порта

#### Синтаксис
```
IN AL, imm8         ; Ввод байта
IN AX, imm8         ; Ввод слова
IN EAX, imm8        ; Ввод двойного слова
IN AL, DX           ; Ввод байта из порта, указанного в DX
IN AX, DX           ; Ввод слова из порта, указанного в DX
IN EAX, DX          ; Ввод двойного слова из порта, указанного в DX
```

#### Описание
Считывает данные из указанного порта ввода-вывода в регистр AL, AX или EAX.

#### Примеры
```assembly
IN AL, 0x60         ; Чтение байта из порта 0x60 (клавиатура в PC)
IN AX, DX           ; Чтение слова из порта, указанного в DX
```

#### Флаги
Не влияет на флаги.

#### Привилегии
В защищенном режиме требует уровень привилегий 0 (режим ядра) или установленный бит IOPL.

#### Применение
- Взаимодействие с устройствами ввода-вывода
- Доступ к аппаратным портам
- Драйверы устройств

### OUT - Вывод в порт

#### Синтаксис
```
OUT imm8, AL        ; Вывод байта
OUT imm8, AX        ; Вывод слова
OUT imm8, EAX       ; Вывод двойного слова
OUT DX, AL          ; Вывод байта в порт, указанный в DX
OUT DX, AX          ; Вывод слова в порт, указанный в DX
OUT DX, EAX         ; Вывод двойного слова в порт, указанный в DX
```

#### Описание
Записывает данные из регистра AL, AX или EAX в указанный порт ввода-вывода.

#### Примеры
```assembly
OUT 0x43, AL        ; Запись байта в порт 0x43 (таймер в PC)
OUT DX, AX          ; Запись слова в порт, указанный в DX
```

#### Флаги
Не влияет на флаги.

#### Привилегии
В защищенном режиме требует уровень привилегий 0 (режим ядра) или установленный бит IOPL.

#### Применение
- Управление устройствами ввода-вывода
- Настройка аппаратных компонентов
- Драйверы устройств

### INS/INSB/INSW/INSD - Ввод строки из порта

#### Синтаксис
```
INSB                ; Ввод байта из порта DX в память по адресу [RDI]
INSW                ; Ввод слова из порта DX в память по адресу [RDI]
INSD                ; Ввод двойного слова из порта DX в память по адресу [RDI]
```

#### Описание
Считывает данные из порта, указанного в DX, и сохраняет их в памяти по адресу [RDI], затем увеличивает или уменьшает RDI в зависимости от флага DF.

#### Примеры
```assembly
CLD                 ; Сброс флага направления (инкремент RDI)
MOV DX, 0x60        ; Порт клавиатуры
MOV RDI, buffer     ; Адрес буфера
INSB                ; Ввод байта из порта 0x60 в [RDI]
```

#### Флаги
Не влияет на флаги.

#### Привилегии
В защищенном режиме требует уровень привилегий 0 (режим ядра) или установленный бит IOPL.

#### Применение
- Быстрый ввод данных из устройств
- Драйверы устройств с DMA

### OUTS/OUTSB/OUTSW/OUTSD - Вывод строки в порт

#### Синтаксис
```
OUTSB               ; Вывод байта из памяти по адресу [RSI] в порт DX
OUTSW               ; Вывод слова из памяти по адресу [RSI] в порт DX
OUTSD               ; Вывод двойного слова из памяти по адресу [RSI] в порт DX
```

#### Описание
Считывает данные из памяти по адресу [RSI] и записывает их в порт, указанный в DX, затем увеличивает или уменьшает RSI в зависимости от флага DF.

#### Примеры
```assembly
CLD                 ; Сброс флага направления (инкремент RSI)
MOV DX, 0x43        ; Порт таймера
MOV RSI, data       ; Адрес данных
OUTSB               ; Вывод байта из [RSI] в порт 0x43
```

#### Флаги
Не влияет на флаги.

#### Привилегии
В защищенном режиме требует уровень привилегий 0 (режим ядра) или установленный бит IOPL.

#### Применение
- Быстрый вывод данных в устройства
- Драйверы устройств с DMA

## Инструкции управления прерываниями

### CLI - Запрет прерываний

#### Синтаксис
```
CLI
```

#### Описание
Сбрасывает флаг прерываний (IF) в регистре RFLAGS, запрещая маскируемые аппаратные прерывания.

#### Примеры
```assembly
CLI                 ; Запрет прерываний
; Критическая секция кода
STI                 ; Разрешение прерываний
```

#### Флаги
Сбрасывает флаг IF.

#### Привилегии
В защищенном режиме требует уровень привилегий 0 (режим ядра) или установленный бит IOPL.

#### Применение
- Защита критических секций кода
- Синхронизация в многозадачных системах
- Обработчики прерываний

### STI - Разрешение прерываний

#### Синтаксис
```
STI
```

#### Описание
Устанавливает флаг прерываний (IF) в регистре RFLAGS, разрешая маскируемые аппаратные прерывания.

#### Примеры
```assembly
STI                 ; Разрешение прерываний
```

#### Флаги
Устанавливает флаг IF.

#### Привилегии
В защищенном режиме требует уровень привилегий 0 (режим ядра) или установленный бит IOPL.

#### Применение
- Восстановление обработки прерываний после критической секции
- Инициализация системы
- Обработчики прерываний

### HLT - Остановка процессора

#### Синтаксис
```
HLT
```

#### Описание
Переводит процессор в состояние остановки до получения прерывания, сигнала сброса или сигнала SMI.

#### Примеры
```assembly
STI                 ; Разрешение прерываний
HLT                 ; Остановка процессора до прерывания
```

#### Флаги
Не влияет на флаги.

#### Привилегии
Требует уровень привилегий 0 (режим ядра).

#### Применение
- Энергосбережение
- Ожидание прерываний
- Реализация простоя процессора

## Инструкции управления памятью

### INVLPG - Инвалидация записи в TLB

#### Синтаксис
```
INVLPG m
```

#### Описание
Инвалидирует (сбрасывает) запись в буфере трансляции адресов (TLB) для указанного линейного адреса.

#### Примеры
```assembly
INVLPG [RAX]        ; Инвалидация записи TLB для адреса в RAX
```

#### Флаги
Не влияет на флаги.

#### Привилегии
Требует уровень привилегий 0 (режим ядра).

#### Применение
- Управление виртуальной памятью
- Изменение таблиц страниц
- Реализация подкачки страниц

### CLFLUSH - Сброс линии кэша

#### Синтаксис
```
CLFLUSH m8
```

#### Описание
Сбрасывает линию кэша, содержащую указанный адрес, обратно в память.

#### Примеры
```assembly
CLFLUSH [RBX]       ; Сброс линии кэша для адреса в RBX
```

#### Флаги
Не влияет на флаги.

#### Применение
- Синхронизация кэша и памяти
- Работа с некэшируемыми данными
- Реализация когерентности кэша в многопроцессорных системах

### PREFETCHT0/PREFETCHT1/PREFETCHT2/PREFETCHNTA - Предварительная загрузка данных

#### Синтаксис
```
PREFETCHT0 m8       ; Предварительная загрузка в кэш всех уровней
PREFETCHT1 m8       ; Предварительная загрузка в кэш L2 и выше
PREFETCHT2 m8       ; Предварительная загрузка в кэш L3 и выше
PREFETCHNTA m8      ; Предварительная загрузка в некэшируемую область
```

#### Описание
Дает процессору подсказку о предварительной загрузке данных в кэш.

#### Примеры
```assembly
PREFETCHT0 [RAX]    ; Предварительная загрузка данных по адресу в RAX
```

#### Флаги
Не влияет на флаги.

#### Применение
- Оптимизация доступа к памяти
- Уменьшение задержек при загрузке данных
- Работа с большими массивами данных

## Инструкции управления сегментацией и дескрипторами

### LGDT/LIDT - Загрузка регистров таблиц дескрипторов

#### Синтаксис
```
LGDT m16&32/64      ; Загрузка регистра глобальной таблицы дескрипторов
LIDT m16&32/64      ; Загрузка регистра таблицы дескрипторов прерываний
```

#### Описание
Загружает базовый адрес и предел таблицы дескрипторов в соответствующий регистр.

#### Примеры
```assembly
LGDT [gdtr]         ; Загрузка GDTR из памяти
LIDT [idtr]         ; Загрузка IDTR из памяти
```

#### Флаги
Не влияет на флаги.

#### Привилегии
Требует уровень привилегий 0 (режим ядра).

#### Применение
- Инициализация системы
- Настройка защищенного режима
- Управление дескрипторами сегментов и прерываний

### LLDT - Загрузка регистра локальной таблицы дескрипторов

#### Синтаксис
```
LLDT r/m16          ; Загрузка регистра локальной таблицы дескрипторов
```

#### Описание
Загружает селектор сегмента в регистр локальной таблицы дескрипторов (LDTR).

#### Примеры
```assembly
LLDT AX             ; Загрузка LDTR из AX
LLDT [RBX]          ; Загрузка LDTR из памяти
```

#### Флаги
Не влияет на флаги.

#### Привилегии
Требует уровень привилегий 0 (режим ядра).

#### Применение
- Многозадачность
- Управление контекстами задач
- Изоляция адресных пространств

### LTR - Загрузка регистра задачи

#### Синтаксис
```
LTR r/m16           ; Загрузка регистра задачи
```

#### Описание
Загружает селектор сегмента в регистр задачи (TR).

#### Примеры
```assembly
LTR AX              ; Загрузка TR из AX
LTR [RBX]           ; Загрузка TR из памяти
```

#### Флаги
Не влияет на флаги.

#### Привилегии
Требует уровень привилегий 0 (режим ядра).

#### Применение
- Многозадачность
- Переключение задач
- Управление состоянием задач

## Инструкции управления режимами процессора

### SIDT/SGDT - Сохранение регистров таблиц дескрипторов

#### Синтаксис
```
SIDT m16&32/64      ; Сохранение регистра таблицы дескрипторов прерываний
SGDT m16&32/64      ; Сохранение регистра глобальной таблицы дескрипторов
```

#### Описание
Сохраняет содержимое регистра таблицы дескрипторов в память.

#### Примеры
```assembly
SIDT [idtr_save]    ; Сохранение IDTR в память
SGDT [gdtr_save]    ; Сохранение GDTR в память
```

#### Флаги
Не влияет на флаги.

#### Применение
- Сохранение состояния системы
- Отладка
- Виртуализация

### SLDT - Сохранение регистра локальной таблицы дескрипторов

#### Синтаксис
```
SLDT r/m16          ; Сохранение регистра локальной таблицы дескрипторов
```

#### Описание
Сохраняет селектор сегмента из регистра локальной таблицы дескрипторов (LDTR) в операнд.

#### Примеры
```assembly
SLDT AX             ; Сохранение LDTR в AX
SLDT [RBX]          ; Сохранение LDTR в память
```

#### Флаги
Не влияет на флаги.

#### Применение
- Сохранение состояния системы
- Отладка
- Виртуализация

### STR - Сохранение регистра задачи

#### Синтаксис
```
STR r/m16           ; Сохранение регистра задачи
```

#### Описание
Сохраняет селектор сегмента из регистра задачи (TR) в операнд.

#### Примеры
```assembly
STR AX              ; Сохранение TR в AX
STR [RBX]           ; Сохранение TR в память
```

#### Флаги
Не влияет на флаги.

#### Применение
- Сохранение состояния системы
- Отладка
- Виртуализация

## Инструкции управления контролем выполнения

### MONITOR - Настройка адреса для мониторинга

#### Синтаксис
```
MONITOR
```

#### Описание
Настраивает адрес для мониторинга операций записи. Адрес берется из RAX.

#### Примеры
```assembly
MOV RAX, address    ; Адрес для мониторинга
MONITOR             ; Настройка мониторинга
```

#### Флаги
Не влияет на флаги.

#### Применение
- Реализация примитивов синхронизации
- Энергосбережение
- Ожидание изменения памяти

### MWAIT - Ожидание изменения в памяти

#### Синтаксис
```
MWAIT
```

#### Описание
Переводит процессор в состояние ожидания до изменения памяти по адресу, настроенному с помощью MONITOR.

#### Примеры
```assembly
MOV RAX, address    ; Адрес для мониторинга
MONITOR             ; Настройка мониторинга
MWAIT               ; Ожидание изменения
```

#### Флаги
Не влияет на флаги.

#### Применение
- Энергосбережение
- Эффективное ожидание событий
- Реализация примитивов синхронизации

### PAUSE - Пауза в цикле ожидания

#### Синтаксис
```
PAUSE
```

#### Описание
Дает подсказку процессору о том, что выполняется цикл ожидания. Улучшает производительность и энергоэффективность.

#### Примеры
```assembly
wait_loop:
    PAUSE           ; Пауза в цикле ожидания
    CMP [lock], 0   ; Проверка условия
    JNE wait_loop   ; Продолжение ожидания
```

#### Флаги
Не влияет на флаги.

#### Применение
- Оптимизация циклов ожидания
- Реализация спинлоков
- Снижение энергопотребления

## Инструкции атомарных операций

### LOCK - Префикс блокировки шины

#### Синтаксис
```
LOCK prefix
```

#### Описание
Префикс, который гарантирует атомарность следующей инструкции путем блокировки шины памяти или использования механизма когерентности кэша.

#### Примеры
```assembly
LOCK INC [counter]  ; Атомарное увеличение счетчика
LOCK XADD [sum], RAX ; Атомарное сложение и обмен
```

#### Флаги
Не влияет на флаги.

#### Применение
- Синхронизация в многопроцессорных системах
- Реализация атомарных операций
- Примитивы синхронизации (мьютексы, семафоры)

### XADD - Обмен и сложение

#### Синтаксис
```
XADD r/m, r
```

#### Описание
Обменивает значения между источником и приемником, затем складывает их и сохраняет результат в приемнике.

#### Примеры
```assembly
LOCK XADD [counter], RAX  ; Атомарно: RAX = [counter], [counter] = [counter] + RAX
```

#### Флаги
Влияет на флаги так же, как ADD.

#### Применение
- Атомарное увеличение счетчиков
- Реализация примитивов синхронизации
- Многопоточное программирование

### CMPXCHG - Сравнение и обмен

#### Синтаксис
```
CMPXCHG r/m, r
```

#### Описание
Сравнивает значение в аккумуляторе (AL/AX/EAX/RAX) с первым операндом. Если они равны, второй операнд загружается в первый операнд. Иначе, первый операнд загружается в аккумулятор.

#### Примеры
```assembly
MOV RAX, old_value  ; Ожидаемое значение
LOCK CMPXCHG [addr], RBX  ; Если [addr] == RAX, то [addr] = RBX, иначе RAX = [addr]
```

#### Флаги
Влияет на флаги так же, как CMP.

#### Применение
- Реализация атомарных операций
- Примитивы синхронизации
- Реализация алгоритмов без блокировок

### CMPXCHG8B/CMPXCHG16B - Сравнение и обмен 8/16 байт

#### Синтаксис
```
CMPXCHG8B m64       ; Сравнение и обмен 8 байт
CMPXCHG16B m128     ; Сравнение и обмен 16 байт
```

#### Описание
Сравнивает 64/128-битное значение в памяти с EDX:EAX/RDX:RAX. Если они равны, ECX:EBX/RCX:RBX загружается в память. Иначе, значение из памяти загружается в EDX:EAX/RDX:RAX.

#### Примеры
```assembly
MOV RAX, low_qword  ; Младшие 64 бита ожидаемого значения
MOV RDX, high_qword ; Старшие 64 бита ожидаемого значения
MOV RBX, low_new    ; Младшие 64 бита нового значения
MOV RCX, high_new   ; Старшие 64 бита нового значения
LOCK CMPXCHG16B [addr]  ; Атомарное сравнение и обмен 16 байт
```

#### Флаги
Устанавливает ZF, если операция успешна.

#### Применение
- Атомарное обновление сложных структур данных
- Реализация алгоритмов без блокировок
- Многопоточное программирование

## Инструкции виртуализации

### VMCALL/VMLAUNCH/VMRESUME/VMXOFF - Инструкции VMX

#### Синтаксис
```
VMCALL              ; Вызов гипервизора
VMLAUNCH            ; Запуск виртуальной машины
VMRESUME            ; Возобновление виртуальной машины
VMXOFF              ; Выключение режима VMX
```

#### Описание
Инструкции для управления виртуальными машинами в технологии Intel VT-x.

#### Привилегии
Требуют уровень привилегий 0 (режим ядра).

#### Применение
- Реализация гипервизоров
- Виртуализация
- Изоляция окружений

### VMMCALL - Инструкция SVM

#### Синтаксис
```
VMMCALL
```

#### Описание
Вызов гипервизора в технологии AMD-V.

#### Привилегии
Требует уровень привилегий 0 (режим ядра).

#### Применение
- Реализация гипервизоров на процессорах AMD
- Виртуализация
- Изоляция окружений

## Примечания

1. Привилегированные инструкции:
   - Большинство системных инструкций требуют уровень привилегий 0 (режим ядра)
   - Попытка выполнения привилегированных инструкций в пользовательском режиме вызывает исключение защиты общего назначения (#GP)

2. Использование в операционных системах:
   - Системные инструкции используются в ядре ОС для управления аппаратными ресурсами
   - Пользовательские программы обычно взаимодействуют с системой через системные вызовы

3. Безопасность:
   - Неправильное использование системных инструкций может привести к нестабильности системы
   - Некоторые инструкции могут быть использованы для атак на безопасность

4. Совместимость:
   - Некоторые системные инструкции доступны только на определенных моделях процессоров
   - Перед использованием расширенных инструкций следует проверить их поддержку с помощью CPUID