# Регистры и режимы адресации x86-64

## Регистры общего назначения

В архитектуре x86-64 доступны 16 64-битных регистров общего назначения:

| 64-битный регистр | Нижние 32 бита | Нижние 16 бит | Нижние 8 бит | Биты 8-15 | Описание |
|-------------------|----------------|---------------|--------------|-----------|----------|
| RAX | EAX | AX | AL | AH | Аккумулятор, используется для арифметических операций, возвращаемых значений функций |
| RBX | EBX | BX | BL | BH | Base, исторически использовался для адресации |
| RCX | ECX | CX | CL | CH | Counter, используется для циклов и операций со строками |
| RDX | EDX | DX | DL | DH | Data, используется для арифметики и ввода-вывода |
| RSI | ESI | SI | SIL | - | Source Index, источник в строковых операциях |
| RDI | EDI | DI | DIL | - | Destination Index, назначение в строковых операциях |
| RBP | EBP | BP | BPL | - | Base Pointer, указатель на базу стекового фрейма |
| RSP | ESP | SP | SPL | - | Stack Pointer, указатель на вершину стека |
| R8 | R8D | R8W | R8B | - | Дополнительный регистр |
| R9 | R9D | R9W | R9B | - | Дополнительный регистр |
| R10 | R10D | R10W | R10B | - | Дополнительный регистр |
| R11 | R11D | R11W | R11B | - | Дополнительный регистр |
| R12 | R12D | R12W | R12B | - | Дополнительный регистр |
| R13 | R13D | R13W | R13B | - | Дополнительный регистр |
| R14 | R14D | R14W | R14B | - | Дополнительный регистр |
| R15 | R15D | R15W | R15B | - | Дополнительный регистр |

## Регистр флагов

Регистр RFLAGS (64-битный) содержит флаги состояния, управления и системные флаги:

| Флаг | Бит | Описание |
|------|-----|----------|
| CF | 0 | Carry Flag - флаг переноса |
| PF | 2 | Parity Flag - флаг четности |
| AF | 4 | Auxiliary Carry Flag - вспомогательный флаг переноса |
| ZF | 6 | Zero Flag - флаг нуля |
| SF | 7 | Sign Flag - флаг знака |
| TF | 8 | Trap Flag - флаг трассировки |
| IF | 9 | Interrupt Enable Flag - флаг разрешения прерываний |
| DF | 10 | Direction Flag - флаг направления для строковых операций |
| OF | 11 | Overflow Flag - флаг переполнения |
| IOPL | 12-13 | I/O Privilege Level - уровень привилегий ввода-вывода |
| NT | 14 | Nested Task - флаг вложенной задачи |
| RF | 16 | Resume Flag - флаг возобновления |
| VM | 17 | Virtual 8086 Mode - режим виртуального 8086 |
| AC | 18 | Alignment Check - проверка выравнивания |
| VIF | 19 | Virtual Interrupt Flag - виртуальный флаг прерывания |
| VIP | 20 | Virtual Interrupt Pending - ожидающее виртуальное прерывание |
| ID | 21 | ID Flag - флаг идентификации |

## Сегментные регистры

Хотя в 64-битном режиме сегментация в основном не используется, сегментные регистры все еще присутствуют:

| Регистр | Описание |
|---------|----------|
| CS | Code Segment - сегмент кода |
| DS | Data Segment - сегмент данных |
| SS | Stack Segment - сегмент стека |
| ES | Extra Segment - дополнительный сегмент |
| FS | F Segment - используется для доступа к TLS (Thread Local Storage) |
| GS | G Segment - используется для доступа к TLS (Thread Local Storage) |

## Регистры для чисел с плавающей точкой и SIMD

### Регистры x87 FPU
8 регистров стека x87 FPU (ST0-ST7) для операций с плавающей точкой.

### MMX регистры
8 64-битных регистров (MM0-MM7), которые совпадают с регистрами x87 FPU.

### SSE регистры
- 16 128-битных регистров XMM0-XMM15 (в 32-битном режиме доступны только XMM0-XMM7)
- Используются для операций SSE, SSE2, SSE3, SSSE3, SSE4

### AVX регистры
- 16 256-битных регистров YMM0-YMM15 (нижние 128 бит совпадают с XMM0-XMM15)
- Используются для операций AVX и AVX2

### AVX-512 регистры
- 32 512-битных регистра ZMM0-ZMM31 (нижние 256 бит совпадают с YMM0-YMM15)
- 8 64-битных регистров маски K0-K7
- Используются для операций AVX-512

## Системные регистры

- CR0-CR4: Control Registers - регистры управления
- DR0-DR7: Debug Registers - регистры отладки
- TR: Task Register - регистр задачи
- GDTR, LDTR, IDTR: Descriptor Table Registers - регистры таблиц дескрипторов
- MSRs: Model-Specific Registers - регистры, специфичные для модели процессора

## Режимы адресации

Архитектура x86-64 поддерживает множество режимов адресации:

### 1. Регистровая адресация
Операнд находится в регистре.
```assembly
MOV RAX, RBX  ; Копирует значение из RBX в RAX
```

### 2. Непосредственная адресация
Операнд задан непосредственно в инструкции.
```assembly
MOV RAX, 42   ; Загружает значение 42 в RAX
```

### 3. Прямая адресация памяти
Операнд находится по указанному адресу в памяти.
```assembly
MOV RAX, [0x1000]  ; Загружает значение из памяти по адресу 0x1000 в RAX
```

### 4. Косвенная регистровая адресация
Адрес операнда находится в регистре.
```assembly
MOV RAX, [RBX]  ; Загружает значение из памяти по адресу, хранящемуся в RBX
```

### 5. Базовая адресация со смещением
Адрес операнда вычисляется как сумма значения в регистре и смещения.
```assembly
MOV RAX, [RBX+16]  ; Загружает значение из памяти по адресу (RBX+16)
```

### 6. Индексная адресация
Адрес операнда вычисляется с использованием базового регистра, индексного регистра и масштаба.
```assembly
MOV RAX, [RBX+RCX*4]  ; Загружает значение из памяти по адресу (RBX+RCX*4)
```

### 7. Базовая индексная адресация со смещением
Комбинация предыдущих режимов.
```assembly
MOV RAX, [RBX+RCX*4+16]  ; Загружает значение из памяти по адресу (RBX+RCX*4+16)
```

### 8. RIP-относительная адресация
Адрес операнда вычисляется относительно значения регистра RIP (указатель инструкций).
```assembly
MOV RAX, [RIP+32]  ; Загружает значение из памяти по адресу (RIP+32)
```

## Соглашения о вызовах (Calling Conventions)

В x86-64 существует несколько соглашений о вызовах, определяющих, как передаются параметры и возвращаются значения функций:

### System V AMD64 ABI (Linux, macOS, FreeBSD)
- Параметры: RDI, RSI, RDX, RCX, R8, R9, затем стек
- Возвращаемое значение: RAX (и RDX для 128-битных значений)
- Сохраняемые регистры: RBX, RBP, R12-R15
- Несохраняемые регистры: RAX, RCX, RDX, RSI, RDI, R8-R11

### Microsoft x64 (Windows)
- Параметры: RCX, RDX, R8, R9, затем стек
- Возвращаемое значение: RAX
- Сохраняемые регистры: RBX, RBP, RDI, RSI, R12-R15
- Несохраняемые регистры: RAX, RCX, RDX, R8-R11
- Требуется выделение 32 байт теневого пространства на стеке

Эти соглашения важны при написании ассемблерного кода или при взаимодействии с кодом на других языках программирования.