# Полный справочник префиксов x86-64

## Структура инструкции с префиксами

```
[Legacy Prefixes] [REX] [VEX/EVEX] [Opcode] [ModR/M] [SIB] [Displacement] [Immediate]
     (0-4 байта)   (0-1)   (2-4)    (1-3)    (0-1)   (0-1)    (0-4)        (0-8)
```

**Важно:** VEX/EVEX не могут сочетаться с Legacy префиксами и REX.

---

## 1. Legacy Prefixes (Унаследованные префиксы)

### Группа 1: Блокировка и повторение

| Префикс | Код | Название | Описание | Применение |
|---------|-----|----------|----------|------------|
| **LOCK** | F0h | Lock | Блокировка шины для атомарных операций | `lock add [mem], reg` |
| **REPNE/REPNZ** | F2h | Repeat Not Equal/Zero | Повторение пока ZF=0 | `repne scasb` |
| **REP/REPE/REPZ** | F3h | Repeat Equal/Zero | Повторение пока ZF=1 | `rep movsb` |

#### Особенности группы 1:
- **LOCK** работает только с определенными инструкциями (ADD, SUB, AND, OR, XOR, ADC, SBB, BTC, BTR, BTS, CMPXCHG, XADD, XCHG)
- **REP** используется со строковыми инструкциями (MOVS, STOS, LODS)
- **REPNE/REPE** - с инструкциями сравнения строк (SCAS, CMPS)
- В SSE/AVX контексте F2h/F3h используются как обязательные префиксы

```assembly
; Примеры
lock add dword ptr [rax], 1    ; F0 83 00 01
rep movsb                      ; F3 A4
repne scasb                    ; F2 AE
```

### Группа 2: Переопределение сегмента

| Префикс | Код | Сегмент | 64-битный режим | Пример |
|---------|-----|---------|----------------|---------|
| **CS:** | 2Eh | Code Segment | Игнорируется | `cs:mov eax, [ebx]` |
| **SS:** | 36h | Stack Segment | Игнорируется | `ss:mov eax, [ebp]` |
| **DS:** | 3Eh | Data Segment | Игнорируется | `ds:mov eax, [esi]` |
| **ES:** | 26h | Extra Segment | Игнорируется | `es:mov eax, [edi]` |
| **FS:** | 64h | FS Segment | **Работает** | `fs:mov rax, [0]` |
| **GS:** | 65h | GS Segment | **Работает** | `gs:mov rax, [rbx]` |

#### Особенности группы 2:
- В 64-битном режиме только FS: и GS: имеют практическое значение
- FS обычно используется для TLS (Thread Local Storage)
- GS используется ядром для per-CPU данных

```assembly
; 64-битные примеры
mov rax, gs:[28h]              ; 65 48 8B 04 25 28 00 00 00
mov fs:[rbx], rax              ; 64 48 89 03
```

### Группа 3: Переопределение размера операнда

| Префикс | Код | Эффект в 16-бит | Эффект в 32-бит | Эффект в 64-бит |
|---------|-----|----------------|----------------|----------------|
| **66h** | 66h | 16→32 бит | 32→16 бит | 64→16 бит |

#### Особенности префикса 66h:
- Меняет размер операнда по умолчанию
- Не влияет на 8-битные операции
- В SSE/AVX имеет специальное значение (packed double-precision)
- REX.W имеет приоритет над 66h

```assembly
; В 64-битном режиме
mov eax, ebx                   ; 89 D8 (32-битная операция)
mov ax, bx                     ; 66 89 D8 (16-битная с префиксом)
mov rax, rbx                   ; 48 89 D8 (64-битная с REX.W)
```

### Группа 4: Переопределение размера адреса

| Префикс | Код | Эффект в 16-бит | Эффект в 32-бит | Эффект в 64-бит |
|---------|-----|----------------|----------------|----------------|
| **67h** | 67h | 16→32 бит адрес | 32→16 бит адрес | 64→32 бит адрес |

#### Особенности префикса 67h:
- Меняет размер адресации по умолчанию
- В 64-битном режиме переключает с 64-битной на 32-битную адресацию
- Влияет на все компоненты адреса (база, индекс, смещение)

```assembly
; В 64-битном режиме
mov eax, [rbx]                 ; 8B 03 (64-битная адресация)
mov eax, [ebx]                 ; 67 8B 03 (32-битная адресация)
```

---

## 2. REX Prefix (только 64-битный режим)

### Структура REX префикса

```
REX = 0100WRXB
```

| Биты | Название | Значение | Функция |
|------|----------|----------|---------|
| 7-4 | Фиксированы | 0100 | Идентификатор REX |
| 3 | **W** | 0/1 | 0=размер по умолчанию, 1=64 бита |
| 2 | **R** | 0/1 | Расширение поля reg в ModR/M |
| 1 | **X** | 0/1 | Расширение поля index в SIB |
| 0 | **B** | 0/1 | Расширение поля r/m или base |

### Все возможные REX префиксы

| Код | Двоичный | W | R | X | B | Описание |
|-----|----------|---|---|---|---|----------|
| 40h | 01000000 | 0 | 0 | 0 | 0 | Пустой REX (доступ к SIL/DIL/SPL/BPL) |
| 41h | 01000001 | 0 | 0 | 0 | 1 | REX.B |
| 42h | 01000010 | 0 | 0 | 1 | 0 | REX.X |
| 43h | 01000011 | 0 | 0 | 1 | 1 | REX.XB |
| 44h | 01000100 | 0 | 1 | 0 | 0 | REX.R |
| 45h | 01000101 | 0 | 1 | 0 | 1 | REX.RB |
| 46h | 01000110 | 0 | 1 | 1 | 0 | REX.RX |
| 47h | 01000111 | 0 | 1 | 1 | 1 | REX.RXB |
| 48h | 01001000 | 1 | 0 | 0 | 0 | REX.W (64-битные операции) |
| 49h | 01001001 | 1 | 0 | 0 | 1 | REX.WB |
| 4Ah | 01001010 | 1 | 0 | 1 | 0 | REX.WX |
| 4Bh | 01001011 | 1 | 0 | 1 | 1 | REX.WXB |
| 4Ch | 01001100 | 1 | 1 | 0 | 0 | REX.WR |
| 4Dh | 01001101 | 1 | 1 | 0 | 1 | REX.WRB |
| 4Eh | 01001110 | 1 | 1 | 1 | 0 | REX.WRX |
| 4Fh | 01001111 | 1 | 1 | 1 | 1 | REX.WRXB |

### Примеры использования REX

```assembly
; REX.W для 64-битных операций
mov rax, rbx                   ; 48 89 D8

; REX.R для расширенных регистров в поле reg
mov rax, r8                    ; 4C 89 C0

; REX.B для расширенных регистров в поле r/m
mov r8, rax                    ; 49 89 C0

; REX.X для расширенных регистров в индексе
mov rax, [rbx+r8]              ; 4A 8B 04 03

; Комбинации
mov r15, [r14+r13*2+8]         ; 4F 8B 7C 6E 08
```

---

## 3. VEX Prefixes (AVX инструкции)

### 2-байтный VEX префикс (C5h)

```
Байт 1: C5h
Байт 2: RvvvvLpp

R (бит 7): инверсия REX.R
vvvv (биты 6-3): дополнительный операнд (инвертированный)  
L (бит 2): длина вектора (0=128 бит, 1=256 бит)
pp (биты 1-0): обязательный префикс (00=нет, 01=66h, 10=F3h, 11=F2h)
```

### 3-байтный VEX префикс (C4h)

```
Байт 1: C4h
Байт 2: RXBmmmmm
Байт 3: WvvvvLpp

RXB: инверсии REX.R, REX.X, REX.B
mmmmm: карта опкодов (01=0F, 02=0F38, 03=0F3A)
W: эквивалент REX.W
vvvv: дополнительный операнд (инвертированный)
L: длина вектора
pp: обязательный префикс
```

### Примеры VEX

```assembly
; 2-байтный VEX
vaddps xmm0, xmm1, xmm2        ; C5 F0 58 C2

; 3-байтный VEX  
vaddps ymm0, ymm1, ymm2        ; C5 F4 58 C2
```

---

## 4. EVEX Prefix (AVX-512)

### Структура EVEX (4 байта)

```
Байт 1: 62h
Байт 2: RXBR'00mm
Байт 3: Wvvvv1pp  
Байт 4: zL'LbV'aaa

RXBR': расширения регистров
mm: карта опкодов
W: размер операнда
vvvv: дополнительный операнд NDS/NDD
pp: обязательный префикс
z: zeroing-masking
L'L: длина вектора (00=128, 01=256, 10=512)
b: broadcast/RC/SAE
V': расширение vvvv
aaa: маска регистр
```

### Пример EVEX

```assembly
vaddps zmm0{k1}, zmm1, zmm2    ; 62 F1 74 49 58 C2
```

---

## 5. Специальные случаи и взаимодействия

### Обязательные префиксы в SSE/AVX

| Префикс | Значение | Пример инструкции |
|---------|----------|-------------------|
| Нет | Packed Single (PS) | `addps xmm0, xmm1` |
| 66h | Packed Double (PD) | `addpd xmm0, xmm1` |
| F3h | Scalar Single (SS) | `addss xmm0, xmm1` |
| F2h | Scalar Double (SD) | `addsd xmm0, xmm1` |

### Конфликтующие префиксы

```assembly
; Нельзя: VEX + Legacy префиксы
66 C5 F0 58 C2                 ; Недопустимо!

; Нельзя: REX + VEX
48 C5 F0 58 C2                 ; Недопустимо!

; Можно: Несколько Legacy префиксов
65 67 66 89 18                 ; gs: addr16 mov [bx], bx
```

### Порядок префиксов

**Правильный порядок:**
```
[Group 1] [Group 2] [Group 3] [Group 4] [REX] [Opcode]
```

**Пример правильного порядка:**
```assembly
lock gs: mov qword ptr [rax], rbx
; F0 65 48 89 18
; F0 (LOCK) + 65 (GS:) + 48 (REX.W) + 89 18 (MOV)
```

---

## 6. Ограничения и правила

### Максимальное количество префиксов
- **Legacy префиксы**: максимум 4 (по одному из каждой группы)
- **REX**: максимум 1
- **VEX/EVEX**: заменяет все остальные префиксы
- **Общая длина инструкции**: максимум 15 байт

### Игнорируемые префиксы
- 66h игнорируется для 8-битных операций
- REX.W игнорируется для 8-битных операций  
- Сегментные префиксы (кроме FS:/GS:) в 64-битном режиме
- REP/REPNE для не-строковых инструкций

### Недопустимые комбинации
- LOCK + MOV (и другие не-атомарные операции)
- VEX/EVEX + любые Legacy префиксы
- VEX/EVEX + REX
- Более одного префикса из одной группы

---

## Заключение

Система префиксов x86-64 сложна из-за исторического развития архитектуры. Ключевые принципы:

1. **Legacy префиксы** - наследие от 16/32-битных режимов
2. **REX** - расширение для 64-битного режима
3. **VEX/EVEX** - современные префиксы для векторных операций
4. **Порядок имеет значение** - соблюдайте правильную последовательность
5. **Не все комбинации допустимы** - изучите ограничения

Для практического использования сосредоточьтесь сначала на REX и основных Legacy префиксах, а VEX/EVEX изучайте при работе с векторными инструкциями.